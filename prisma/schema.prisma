// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Preferences
  newsletterSubscribed Boolean @default(false)

  // Relations
  accounts           Account[]
  readingList        ReadingListItem[]
  articleProgress    ArticleProgress[]
  courseProgress     CourseProgress[]
  certificates       Certificate[]
  quizAttempts       QuizAttempt[]
  purchases          Purchase[]
  exerciseResponses  ExerciseResponse[]
  journalEntries     JournalEntry[]
  profile            UserProfile?
  subscription       Subscription?
  aiCredits          AICredits?
  aiUsage            AIUsage[]
  chatConversations  ChatConversation[]
  creditPurchases    CreditPurchase[]
  assessmentResults  AssessmentResult[]
  sharedReflections  SharedReflection[]
  dreamEntries       DreamEntry[]
  integrationCheckIns IntegrationCheckIn[]

  // Integration Health System
  integrationHealth    IntegrationHealth[]
  pillarHealth         PillarHealth[]
  healthSessions       HealthSession[]
  reassessmentTriggers ReassessmentTrigger[]
  quickCheckIns        QuickCheckIn[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@index([userId])
}

model ReadingListItem {
  id        String   @id @default(cuid())
  userId    String
  slug      String
  title     String?
  addedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
}

model ArticleProgress {
  id             String   @id @default(cuid())
  userId         String
  slug           String
  completed      Boolean  @default(false)
  completedAt    DateTime?
  scrollProgress Float    @default(0) // Percentage of article read (0-100)
  lastReadAt     DateTime @default(now()) // When user last read this article
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
}

model CourseProgress {
  id           String   @id @default(cuid())
  userId       String
  courseSlug   String
  moduleSlug   String
  completed    Boolean  @default(false)
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug, moduleSlug])
  @@index([userId])
  @@index([userId, courseSlug])
}

model Certificate {
  id            String   @id @default(cuid())
  userId        String
  courseSlug    String
  courseName    String
  userName      String
  issuedAt      DateTime @default(now())
  certificateId String   @unique @default(cuid())

  // Certificate tiering
  credentialType String  @default("completion") // completion, certificate
  courseTier     String  @default("beginner")   // intro, beginner, intermediate, advanced, flagship
  quizScore      Int?    // Score achieved on quiz (if applicable)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug])
  @@index([userId])
}

model QuizAttempt {
  id           String   @id @default(cuid())
  userId       String
  courseSlug   String
  score        Int      // Percentage 0-100
  passed       Boolean
  answers      String   // JSON string of answers
  attemptedAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, courseSlug])
}

model Purchase {
  id                String   @id @default(cuid())
  userId            String
  courseSlug        String
  stripePaymentId   String   @unique
  stripeCustomerId  String?
  amount            Int      // Amount in cents
  currency          String   @default("usd")
  status            String   @default("completed") // completed, refunded
  purchasedAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug])
  @@index([userId])
  @@index([stripePaymentId])
}

model ExerciseResponse {
  id          String   @id @default(cuid())
  userId      String
  courseSlug  String
  moduleSlug  String
  exerciseId  String
  type        String   // checkbox, journal, list
  value       String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug, moduleSlug, exerciseId])
  @@index([userId])
  @@index([userId, courseSlug])
}

model JournalEntry {
  id          String   @id @default(cuid())
  userId      String
  title       String?
  content     String   @db.Text
  promptId    String?  // Optional: links to a daily prompt
  mood        String?  // Optional: emotional state
  tags        String?  // JSON array of tags
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// User Profile - "Learn to Know" onboarding data
// This captures where the user is in their journey to personalize recommendations
model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Onboarding completed?
  onboardingCompleted Boolean @default(false)

  // What brings you here? (primary intention)
  primaryIntention String? // healing, growth, understanding, crisis, curiosity

  // Current life situation
  lifeSituation String? // stable, transition, crisis, rebuilding

  // Experience levels (1-5 scale, stored as JSON)
  // e.g., {"meditation": 3, "therapy": 4, "bodywork": 2, "psychedelics": 1, "spiritualPractice": 2}
  experienceLevels String? @db.Text

  // Has had transcendent/awakening experiences?
  hasAwakeningExperience Boolean @default(false)
  awakeningDescription   String? @db.Text

  // Current challenges (JSON array)
  // e.g., ["anxiety", "relationships", "purpose", "grief", "identity"]
  currentChallenges String? @db.Text

  // What they're most drawn to (JSON array of categories/topics)
  // e.g., ["shadow-work", "nervous-system", "relationships", "meaning"]
  interests String? @db.Text

  // Preferred depth level
  depthPreference String? // foundational, intermediate, deep, advanced

  // How they learn best
  learningStyle String? // reading, reflection, exercises, community

  // Time available for practice
  timeAvailable String? // minimal, moderate, dedicated

  // Any specific areas to avoid or be careful with
  sensitivities String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Subscription tiers: seeker, practitioner, master
model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  tier                 String    // seeker, practitioner, master
  status               String    @default("active") // active, canceled, past_due, paused
  stripeSubscriptionId String    @unique
  stripeCustomerId     String
  stripePriceId        String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeSubscriptionId])
}

// AI Credits - token-based system
// 1 credit = 1,000 tokens, but we track in tokens for precision
model AICredits {
  id                 String   @id @default(cuid())
  userId             String   @unique
  tokenBalance       Int      @default(0) // Current available tokens
  monthlyTokens      Int      @default(0) // Tokens included with subscription tier (reset monthly)
  monthlyUsed        Int      @default(0) // Tokens used this billing period
  purchasedTokens    Int      @default(0) // Purchased tokens (never expire)
  lastMonthlyReset   DateTime @default(now()) // When monthly tokens were last reset
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Track AI usage for billing and analytics
model AIUsage {
  id           String   @id @default(cuid())
  userId       String
  inputTokens  Int      // Actual input tokens used
  outputTokens Int      // Actual output tokens used
  totalTokens  Int      // inputTokens + outputTokens
  cost         Float    // Actual cost in dollars (for analytics)
  model        String   @default("claude-sonnet-4.5")
  context      String?  // chat, course-help, journal-reflection, etc.
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// Credit purchases (tokens)
model CreditPurchase {
  id               String    @id @default(cuid())
  userId           String
  credits          Int       // Number of credits purchased (1 credit = 1,000 tokens)
  tokens           Int       // Actual tokens added (credits * 1000)
  amount           Int       // Amount in cents
  stripePaymentId  String    @unique
  refunded         Boolean   @default(false) // Whether this purchase was refunded
  refundedAt       DateTime? // When the refund was processed
  createdAt        DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Assessment Results - stores user's self-discovery assessment outcomes
model AssessmentResult {
  id          String   @id @default(cuid())
  userId      String
  type        String   // archetype, attachment, nervous-system, values
  results     String   @db.Text // JSON string with full results
  summary     String?  @db.Text // Brief summary for display
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type]) // One result per type per user (updates replace)
  @@index([userId])
  @@index([userId, type])
}

// Anonymous Reflections - shared with the community
model SharedReflection {
  id          String   @id @default(cuid())
  userId      String
  content     String   @db.Text // The reflection text
  topic       String?  // shadow, growth, relationships, meaning, healing, etc.
  mood        String?  // grateful, struggling, hopeful, confused, peaceful
  responses   SharedReflectionResponse[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([topic, createdAt(sort: Desc)])
}

// Responses to shared reflections (also anonymous)
model SharedReflectionResponse {
  id           String   @id @default(cuid())
  reflectionId String
  userId       String
  content      String   @db.Text
  createdAt    DateTime @default(now())

  reflection SharedReflection @relation(fields: [reflectionId], references: [id], onDelete: Cascade)

  @@index([reflectionId, createdAt])
}

// Integration Check-ins - periodic prompts to reflect on applying learnings
model IntegrationCheckIn {
  id           String   @id @default(cuid())
  userId       String
  type         String   // weekly, course-completion, milestone
  promptType   String   // what-shifted, applying-learning, current-edge, gratitude
  response     String   @db.Text
  relatedSlug  String?  // Optional: course or content slug this relates to
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// Dream Journal entries
model DreamEntry {
  id              String   @id @default(cuid())
  userId          String
  title           String?
  content         String   @db.Text // The dream description
  emotions        String?  // JSON array of emotions felt in/about the dream
  symbols         String?  // JSON array of notable symbols identified
  interpretation  String?  @db.Text // AI-assisted or user interpretation
  recurring       Boolean  @default(false)
  lucid           Boolean  @default(false)
  dreamDate       DateTime @default(now()) // When the dream occurred
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, dreamDate])
}

// ============================================================================
// INTEGRATION HEALTH SYSTEM
// Tracks user's development across four pillars (Mind, Body, Soul, Relationships)
// with spectrum stages (Collapse, Regulation, Integration, Embodiment, Optimization)
// ============================================================================

// Overall Integration Health snapshot - computed periodically from all data sources
model IntegrationHealth {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())

  // Pillar scores (0-100) representing overall health in each area
  mindScore          Int      @default(0)
  bodyScore          Int      @default(0)
  soulScore          Int      @default(0)
  relationshipsScore Int      @default(0)

  // Spectrum stages for each pillar
  // collapse, regulation, integration, embodiment, optimization
  mindStage          String   @default("regulation")
  bodyStage          String   @default("regulation")
  soulStage          String   @default("regulation")
  relationshipsStage String   @default("regulation")

  // AI-generated summary of current state and recommendations
  summary            String?  @db.Text // JSON: { insight, strengths, challenges, nextSteps }

  // Data sources used for this snapshot
  dataSourcesUsed    String?  @db.Text // JSON array of what was analyzed

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// Pillar-specific health tracking - more granular per-pillar data
model PillarHealth {
  id        String   @id @default(cuid())
  userId    String
  pillar    String   // mind, body, soul, relationships
  createdAt DateTime @default(now())

  // Current spectrum stage
  stage     String   @default("regulation") // collapse, regulation, integration, embodiment, optimization

  // Sub-dimensions within this pillar (JSON)
  // Mind: { shadowWork: 65, emotionalIntelligence: 45, cognitiveClarity: 70 }
  // Body: { nervousSystem: 50, physicalHealth: 60, embodiment: 40 }
  // Soul: { meaningfulness: 55, spiritualPractice: 30, presence: 45 }
  // Relationships: { attachmentSecurity: 35, boundaries: 60, intimacy: 40 }
  dimensions String?  @db.Text

  // Trend direction: improving, stable, declining
  trend     String   @default("stable")

  // Key insights for this pillar
  insights  String?  @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pillar])
  @@index([userId])
}

// Weekly AI reflection sessions - structured check-ins that update health
model HealthSession {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())

  // Session type: weekly-checkin, crisis-support, progress-review, reassessment
  type      String   @default("weekly-checkin")

  // The conversation - stored as JSON array of messages
  messages  String   @db.Text // [{ role, content, timestamp }]

  // AI analysis of the session
  analysis  String?  @db.Text // JSON: { themes, emotionalState, pillarInsights, recommendations }

  // Health updates triggered by this session
  healthUpdates String? @db.Text // JSON: { pillar: { dimension, change, reason } }

  // Whether session is complete or in progress
  status    String   @default("in_progress") // in_progress, completed, abandoned

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// Reassessment prompts and triggers
model ReassessmentTrigger {
  id           String   @id @default(cuid())
  userId       String
  createdAt    DateTime @default(now())

  // Which assessment to retake
  assessmentType String // archetype, attachment, nervous-system, pillar-check

  // Why triggered
  reason       String   // time-based, activity-detected, user-requested, crisis-detected

  // Additional context
  context      String?  @db.Text

  // Status
  status       String   @default("pending") // pending, shown, completed, dismissed

  // When shown/actioned
  shownAt      DateTime?
  completedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
}

// Quick daily mood/energy check-ins (lightweight tracking)
model QuickCheckIn {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())

  // Simple 1-5 scales
  mood      Int      // 1=struggling, 2=low, 3=okay, 4=good, 5=great
  energy    Int      // 1=exhausted, 2=low, 3=moderate, 4=good, 5=high

  // Optional brief note (max ~200 chars)
  note      String?

  // Which pillar feels most activated/challenged today
  pillarFocus String? // mind, body, soul, relationships

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// ============================================================================
// CHAT CONVERSATIONS
// Persistent chat history for standalone AI chat
// ============================================================================

model ChatConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?  // Auto-generated or user-set conversation title
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Conversation context/mode
  mode      String   @default("general") // general, growth, crisis, dream, shadow, etc.

  // Whether this is the active/current conversation
  isActive  Boolean  @default(true)

  // Messages in this conversation
  messages  ChatMessage[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, updatedAt])
  @@index([userId, isActive])
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // user, assistant
  content        String   @db.Text
  createdAt      DateTime @default(now())

  // Token usage for this message (for assistant messages)
  inputTokens    Int?
  outputTokens   Int?

  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, createdAt])
}
