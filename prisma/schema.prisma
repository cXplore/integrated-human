// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Preferences
  newsletterSubscribed Boolean @default(false)

  // Relations
  accounts           Account[]
  readingList        ReadingListItem[]
  articleProgress    ArticleProgress[]
  courseProgress     CourseProgress[]
  certificates       Certificate[]
  quizAttempts       QuizAttempt[]
  purchases          Purchase[]
  exerciseResponses  ExerciseResponse[]
  journalEntries     JournalEntry[]
  profile            UserProfile?
  subscription       Subscription?
  aiCredits          AICredits?
  assessmentResults  AssessmentResult[]
  sharedReflections  SharedReflection[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model ReadingListItem {
  id        String   @id @default(cuid())
  userId    String
  slug      String
  title     String?
  addedAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
}

model ArticleProgress {
  id          String   @id @default(cuid())
  userId      String
  slug        String
  completed   Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
}

model CourseProgress {
  id           String   @id @default(cuid())
  userId       String
  courseSlug   String
  moduleSlug   String
  completed    Boolean  @default(false)
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug, moduleSlug])
  @@index([userId])
  @@index([userId, courseSlug])
}

model Certificate {
  id           String   @id @default(cuid())
  userId       String
  courseSlug   String
  courseName   String
  userName     String
  issuedAt     DateTime @default(now())
  certificateId String  @unique @default(cuid())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug])
  @@index([userId])
}

model QuizAttempt {
  id           String   @id @default(cuid())
  userId       String
  courseSlug   String
  score        Int      // Percentage 0-100
  passed       Boolean
  answers      String   // JSON string of answers
  attemptedAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, courseSlug])
}

model Purchase {
  id                String   @id @default(cuid())
  userId            String
  courseSlug        String
  stripePaymentId   String   @unique
  stripeCustomerId  String?
  amount            Int      // Amount in cents
  currency          String   @default("usd")
  status            String   @default("completed") // completed, refunded
  purchasedAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug])
  @@index([userId])
  @@index([stripePaymentId])
}

model ExerciseResponse {
  id          String   @id @default(cuid())
  userId      String
  courseSlug  String
  moduleSlug  String
  exerciseId  String
  type        String   // checkbox, journal, list
  value       String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug, moduleSlug, exerciseId])
  @@index([userId])
  @@index([userId, courseSlug])
}

model JournalEntry {
  id          String   @id @default(cuid())
  userId      String
  title       String?
  content     String   @db.Text
  promptId    String?  // Optional: links to a daily prompt
  mood        String?  // Optional: emotional state
  tags        String?  // JSON array of tags
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

// User Profile - "Learn to Know" onboarding data
// This captures where the user is in their journey to personalize recommendations
model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Onboarding completed?
  onboardingCompleted Boolean @default(false)

  // What brings you here? (primary intention)
  primaryIntention String? // healing, growth, understanding, crisis, curiosity

  // Current life situation
  lifeSituation String? // stable, transition, crisis, rebuilding

  // Experience levels (1-5 scale, stored as JSON)
  // e.g., {"meditation": 3, "therapy": 4, "bodywork": 2, "psychedelics": 1, "spiritualPractice": 2}
  experienceLevels String? @db.Text

  // Has had transcendent/awakening experiences?
  hasAwakeningExperience Boolean @default(false)
  awakeningDescription   String? @db.Text

  // Current challenges (JSON array)
  // e.g., ["anxiety", "relationships", "purpose", "grief", "identity"]
  currentChallenges String? @db.Text

  // What they're most drawn to (JSON array of categories/topics)
  // e.g., ["shadow-work", "nervous-system", "relationships", "meaning"]
  interests String? @db.Text

  // Preferred depth level
  depthPreference String? // foundational, intermediate, deep, advanced

  // How they learn best
  learningStyle String? // reading, reflection, exercises, community

  // Time available for practice
  timeAvailable String? // minimal, moderate, dedicated

  // Any specific areas to avoid or be careful with
  sensitivities String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Subscription tiers: seeker, practitioner, master
model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  tier                 String    // seeker, practitioner, master
  status               String    @default("active") // active, canceled, past_due, paused
  stripeSubscriptionId String    @unique
  stripeCustomerId     String
  stripePriceId        String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeSubscriptionId])
}

// AI Credits - token-based system
// 1 credit = 1,000 tokens, but we track in tokens for precision
model AICredits {
  id                 String   @id @default(cuid())
  userId             String   @unique
  tokenBalance       Int      @default(0) // Current available tokens
  monthlyTokens      Int      @default(0) // Tokens included with subscription tier (reset monthly)
  monthlyUsed        Int      @default(0) // Tokens used this billing period
  purchasedTokens    Int      @default(0) // Purchased tokens (never expire)
  lastMonthlyReset   DateTime @default(now()) // When monthly tokens were last reset
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Track AI usage for billing and analytics
model AIUsage {
  id           String   @id @default(cuid())
  userId       String
  inputTokens  Int      // Actual input tokens used
  outputTokens Int      // Actual output tokens used
  totalTokens  Int      // inputTokens + outputTokens
  cost         Float    // Actual cost in dollars (for analytics)
  model        String   @default("claude-sonnet-4.5")
  context      String?  // chat, course-help, journal-reflection, etc.
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
}

// Credit purchases (tokens)
model CreditPurchase {
  id               String   @id @default(cuid())
  userId           String
  credits          Int      // Number of credits purchased (1 credit = 1,000 tokens)
  tokens           Int      // Actual tokens added (credits * 1000)
  amount           Int      // Amount in cents
  stripePaymentId  String   @unique
  createdAt        DateTime @default(now())

  @@index([userId])
}

// Assessment Results - stores user's self-discovery assessment outcomes
model AssessmentResult {
  id          String   @id @default(cuid())
  userId      String
  type        String   // archetype, attachment, nervous-system, values
  results     String   @db.Text // JSON string with full results
  summary     String?  @db.Text // Brief summary for display
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type]) // One result per type per user (updates replace)
  @@index([userId])
  @@index([userId, type])
}

// Anonymous Reflections - shared with the community
model SharedReflection {
  id          String   @id @default(cuid())
  userId      String
  content     String   @db.Text // The reflection text
  topic       String?  // shadow, growth, relationships, meaning, healing, etc.
  mood        String?  // grateful, struggling, hopeful, confused, peaceful
  responses   SharedReflectionResponse[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([topic, createdAt(sort: Desc)])
}

// Responses to shared reflections (also anonymous)
model SharedReflectionResponse {
  id           String   @id @default(cuid())
  reflectionId String
  userId       String
  content      String   @db.Text
  createdAt    DateTime @default(now())

  reflection SharedReflection @relation(fields: [reflectionId], references: [id], onDelete: Cascade)

  @@index([reflectionId, createdAt])
}
